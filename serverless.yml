service: currency-alarm-api

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage, 'dev'}
  provider: 
  region: eu-west-1
  timeout: 5
  memorySize: 256
  apiGateway:
    minimumCompressionSize: 1024
    shouldStartNameWithService: true
  tracing:
    apiGateway: true
    lambda: true

  environment:
    EMERGENCY_TOPIC: !Ref EmergencyRoomTopic
    CURRENCY_RATES_TABLE_NAME: "CurrencyRatesTable"

package:
  individually: true

plugins:
  - serverless-webpack
  - serverless-offline

custom:
  webpack:
    webpackConfig: 'webpack.config.js'
    includeModules: true
    keepOutputDirectory: true
    packager: 'npm'

  dotenv:
    required:
      file: true

functions:
  convertCurrencyApi:
    handler: src/convert-currency.convertCurrency
    events:
      - http:
          path: convert-currency
          method: get
          cors: true

          request:
            parameters:
              querystrings:
                name: true
  
  getCurrencyRates:
    handler: src/get-currency-rate.getCurrencyRates
    events:
      - http:
          path: get-currency-rate
          method: get
          cors: true

  updateCurrencyQuotesScheduler:
    handler: src/update-currency-quotes.updateCurrencyQuotes
    events:
      - schedule:
          name: update-currency-quotes-in-N-hour
          description: 'pull new quotes -> update table'
          rate: rate(1 hours)
          enabled: true

resources:
  Resources:
    EmergencyRoomTopic:
      Type: AWS::SNS::Topic
      Properties:
        DisplayName: Any errors
        TopicName: emergency-room

    # -> https://docs.aws.amazon.com/sns/latest/dg/sns-subscription-filter-policies.html
    EmergencyRoomEmailSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        TopicArn: !Ref EmergencyRoomTopic
        Protocol: email
        Endpoint: Daniil_Shurygin@epam.com

    CurrencyRatesTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:provider.environment.CURRENCY_RATES_TABLE_NAME}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: currencyType
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
          - AttributeName: currencyType
            KeyType: RANGE # same partition
        ProvisionedThroughput:
           ReadCapacityUnits: 1
           WriteCapacityUnits: 1